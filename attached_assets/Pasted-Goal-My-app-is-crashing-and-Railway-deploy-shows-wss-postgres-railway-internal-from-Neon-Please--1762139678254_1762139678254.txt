Goal: My app is crashing and Railway deploy shows wss://postgres.railway.internal from Neon. Please refactor to standard pg and make the server resilient to port conflicts.

Do these tasks exactly:

Remove Neon everywhere (source only).

Replace any imports from @neondatabase/serverless → pg

Replace any imports from drizzle-orm/neon-serverless → drizzle-orm/node-postgres

Remove all neonConfig and any WebSocket usage for Postgres (e.g., wss://postgres.railway.internal)

Make sure these files use pg:

server/db.ts:

import { Pool } from "pg";
import { drizzle } from "drizzle-orm/node-postgres";

const needSSL =
  /\brailway\.app\b|amazonaws\.com\b|neon\.tech\b/i.test(process.env.DATABASE_URL || "");

export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: needSSL ? { rejectUnauthorized: false } : false,
});

export const db = drizzle(pool);
export default db;


server/services/geocoding.ts must import Pool from "pg" (not Neon) and receive/use the same pg pool instance.

Fix the port-in-use crash and add graceful shutdown.

In the main server entry (e.g., server/index.ts), replace the listen block with:

const PORT = Number(process.env.PORT) || 5000;

function start(port: number) {
  const server = app.listen(port, "0.0.0.0", () => {
    console.log(`[express] serving on port ${port}`);
  });

  server.on("error", (err: any) => {
    if (err?.code === "EADDRINUSE") {
      const fallback = Math.floor(Math.random() * (5999 - 5100) + 5100);
      console.warn(`[express] Port ${port} in use. Retrying on ${fallback}...`);
      start(fallback);
    } else {
      throw err;
    }
  });

  // graceful shutdown
  const shutdown = async () => {
    console.log("[express] shutting down…");
    try { await pool.end(); } catch {}
    server.close(() => process.exit(0));
  };
  process.on("SIGTERM", shutdown);
  process.on("SIGINT", shutdown);
}

start(PORT);


Add a minimal healthcheck route:

app.get("/health", (_req, res) => res.status(200).json({ ok: true }));


Clean up package.json and scripts.

Remove @neondatabase/serverless from dependencies/devDependencies.

Ensure pg is present (latest).

Keep drizzle-orm, but not the neon adapters.

Add scripts:

"scripts": {
  "dev": "NODE_ENV=development tsx server/index.ts",
  "build": "esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/index.js",
  "start": "node dist/index.js",
  "fix:ports": "pkill -9 -f node || true && pkill -9 -f vite || true && pkill -9 -f tsx || true && npx kill-port 5000 5050 5173 3000 || true"
}


Make sure dist/ is not tracked so Railway can’t reuse stale Neon bundles.

Add dist/ to .gitignore, untrack if necessary.

Run a clean install and build, then start.

Execute in the shell:

rm -rf node_modules dist .cache .bun package-lock.json
npm install
npm run build
npm start


The app should start without EADDRINUSE and without any Neon/WebSocket errors.

Leave a brief summary of changes and confirm that:

/health returns { ok: true }

The console shows [express] serving on port ...

No logs mention wss://postgres.railway.internal or @neondatabase/serverless.