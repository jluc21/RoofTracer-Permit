ðŸ§  Replit Agent â€” One-Shot Fix & Deploy Prep

Context (do this first):
The app is crashing on Replit with EADDRINUSE (port already in use). Railway deploy logs still show wss://postgres.railway.internal from Neonâ€™s WebSocket driver. We must permanently remove Neon and use pg + drizzle-orm/node-postgres, add auto-fallback ports and graceful shutdown, and run a clean build so Railway doesnâ€™t reuse stale bundles.

Do all of the following automatically (no manual shell use):

Remove Neon everywhere (source code only).

Replace any imports of @neondatabase/serverless â†’ pg.

Replace any imports of drizzle-orm/neon-serverless â†’ drizzle-orm/node-postgres.

Remove any references to neonConfig and any WebSocket usage for Postgres (e.g., wss://postgres.railway.internal).

Ensure server/db.ts is exactly this:

import { Pool } from "pg";
import { drizzle } from "drizzle-orm/node-postgres";

const needSSL =
  /\brailway\.app\b|amazonaws\.com\b|neon\.tech\b/i.test(process.env.DATABASE_URL || "");

export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: needSSL ? { rejectUnauthorized: false } : false,
});

export const db = drizzle(pool);
export default db;


Ensure server/services/geocoding.ts imports Pool from "pg" (not Neon) and uses the same pg Pool instance (no WebSockets).

Fix port-in-use crashes + add graceful shutdown & healthcheck.

In the server entry (server/index.ts), replace the listen/start block with:

const PORT = Number(process.env.PORT) || 5000;

function start(port: number) {
  const server = app.listen(port, "0.0.0.0", () => {
    console.log(`[express] serving on port ${port}`);
  });

  server.on("error", (err: any) => {
    if (err?.code === "EADDRINUSE") {
      const fallback = Math.floor(Math.random() * (5999 - 5100) + 5100);
      console.warn(`[express] Port ${port} in use. Retrying on ${fallback}...`);
      start(fallback);
    } else {
      throw err;
    }
  });

  const shutdown = async () => {
    console.log("[express] shutting downâ€¦");
    try { await pool.end(); } catch {}
    server.close(() => process.exit(0));
  };
  process.on("SIGTERM", shutdown);
  process.on("SIGINT", shutdown);
}

start(PORT);

// healthcheck
app.get("/health", (_req, res) => res.status(200).json({ ok: true }));


Update package.json and scripts.

Remove @neondatabase/serverless from dependencies/devDependencies (and any neon adapters).

Ensure pg is present.

Ensure scripts are:

"scripts": {
  "dev": "NODE_ENV=development tsx server/index.ts",
  "build": "esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/index.js",
  "start": "node dist/index.js",
  "fix:ports": "pkill -9 -f node || true && pkill -9 -f vite || true && pkill -9 -f tsx || true && npx kill-port 5000 5050 5173 3000 || true"
}


If Replit requires confirmations for npx kill-port, auto-confirm it or install it as a dev dependency and run it non-interactively.

Make sure dist/ is not tracked & wonâ€™t be deployed stale.

Add dist/ to .gitignore.

If dist/ is tracked, untrack it.

Run the full clean workflow automatically (no manual shell).

Programmatically run these commands in sequence:

rm -rf node_modules dist .cache .bun package-lock.json

npm install

npm run build

npm start

Before starting, run npm run fix:ports to clear any zombie processes.

If port 5000 is busy, the fallback logic must kick in automatically (51xx range). Do not require manual input.

Verify success.

Open /health and confirm it returns { ok: true }.

Confirm console shows:

[express] serving on port <port>

[Geocoding] Cache table initialized

Confirm there are no references in logs to:

@neondatabase/serverless

drizzle-orm/neon-serverless

neonConfig

wss://postgres.railway.internal

Leave a short summary of changes performed and the exact port the app is running on.

(Prep for Railway deploy)

Remind me to:

Set env var DATABASE_URL in Railway.

If using Public URL, include ?sslmode=require.

If using Internal URL, our pg config handles it; no extra flags needed.

Clear Railway build cache and then Redeploy (this step Iâ€™ll do in Railway UI).

After redeploy, expected logs on Railway:

[express] serving on port <assigned>

[Geocoding] Cache table initialized

No Neon/WebSocket messages.

Important: Please perform all steps above automatically (file edits, dependency changes, killing ports, clean install/build/start, verification). I do not want to run any shell commands manually.